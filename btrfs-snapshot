#!/bin/bash
#
# btrfs-snapshot - tool for creating btrfs snapshots
#

declare -r filename=${0##*/} version=%VERSION%

_f_parseopts=parseopts
_d_config=btrfs-snapshot

usage() {
    cat <<EOF
btrfs-snapshot $version
usage: $filename [options]

  Options:
   -c, --confdir                    Use config files in \`$_d_config'
   -d, --dest <path>                Destination for snapshot
   -h, --help                       Display this message and exit
   -n, --nkeep <number>             Limit number of snapshots to keep (default: no)
   -V, --version                    Display version information and exit
   -s, --subvol <mountpoint>        Mountpoint for subvolume
   -w, --writable                   Create a writable snapshot (default: no)

EOF
}

version() {
    cat <<EOF
btrfs-snapshot $version
EOF
}

check_option() {
    local -i _code=0
    [[ $subvol ]] || {
        echo "$filename: requires option '-s'"
        _code=1
    }
    [[ $dest ]] || {
        echo "$filename: requires option '-d'"
        _code=1
    }
    return $_code
}

snapshot() {
    mkdir -p "$dest"
    snapshot=$dest/$(date -I)
    [[ ! -d $snapshot ]] || {
        echo "$filename: snapshot on '$dest' already exists"
        return 1
    }
}

create() {
    if [[ $writable == true ]]; then
        btrfs subvolume snapshot "$subvol" "$snapshot"
    else
        btrfs subvolume snapshot -r "$subvol" "$snapshot"
    fi
}

delete() {
    local _ndel=$(( $(ls "$dest" | wc -l) - nkeep ))
    (( _ndel > 0 )) && {
        local _snapshot=()
        mapfile -t _snapshot < <(ls -d "$dest"/* | head -n $_ndel)
        btrfs subvolume delete "${_snapshot[@]}"
    }
}

main() {
    check_option || return
    snapshot || return
    create || return
    if [[ $nkeep ]]; then
        delete
    else
        return 0
    fi
}

. "$_f_parseopts"

trap 'exit 130' INT
trap 'exit 143' TERM

_opt_short='cd:hn:Vs:w'
_opt_long=('confdir' 'dest:' 'help' 'nkeep:' 'version' 'subvol:' 'writable')

parseopts "$_opt_short" "${_opt_long[@]}" -- "$@" || exit 1
set -- "${OPTRET[@]}"
unset _opt_short _opt_long OPTRET

while :; do
    case $1 in
        -c|--confdir)
            confdir=true
            shift
            break 2
            ;;
        -d|--dest)
            op_dest=true
            shift
            dest=$1
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -n|--nkeep)
            shift
            declare -i nkeep=$1
            ;;
        -V|--version)
            version
            exit 0
            ;;
        -s|--subvol)
            op_subvol=true
            shift
            subvol=$1
            ;;
        -w|--writable)
            writable=true
            ;;
        --)
            shift
            break 2
            ;;
    esac
    shift
done

[[ $op_subvol != true ]] && [[ $op_dest != true ]] && {
    confdir=true
}

if [[ $confdir == true ]]; then
    for conf in "$_d_config"/*.conf
    do
        . "$conf"
        main
    done
else
    main
fi

exit 0

# vim: set ft=sh ts=4 sw=4 et:
